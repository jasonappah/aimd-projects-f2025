<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypoglycemia Historical Data Explorer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .alert-high { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .alert-medium { background-color: #fffbeb; border-color: #f59e0b; color: #92400e; }
        .alert-low { background-color: #ecfdf5; border-color: #10b981; color: #065f46; }
        .gauge-line { transition: stroke-dashoffset 1s ease-in-out; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-gray-800">Historical Hypoglycemia Data Explorer</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1">Showing data for Patient ID: â€”</p>
        </header>

        <!-- Patient ID Search Panel -->
        <div class="card bg-gray-50 p-6 rounded-xl border-2 border-dashed border-gray-300">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Patient Lookup</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="number" id="patient-id-input" placeholder="Enter Patient ID (e.g., 1 or 5000)" value="1" min="1" class="p-3 border border-gray-300 rounded-lg flex-grow max-w-xs">
                <button onclick="loadPatientDataFromInput()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150">
                    Load Patient Data
                </button>
            </div>
            <p id="data-status" class="mt-4 text-sm font-medium text-gray-600">Loading initial dataset...</p>
        </div>


        <!-- Main Risk Card -->
        <div id="risk-card" class="card bg-white p-6 rounded-xl border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Hypo Risk at Last Entry
            </h2>
            <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                
                <!-- Risk Gauge -->
                <div class="relative w-32 h-32">
                    <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
                        <!-- Background arc -->
                        <path id="gauge-bg" class="text-gray-200"
                              stroke="currentColor" stroke-width="3" fill="none"
                              d="M18 2.0845
                                 a 15.9155 15.9155 0 0 1 0 31.831
                                 a 15.9155 15.9155 0 0 1 0 -31.831"
                        />
                        <!-- Actual risk arc (dynamic color and length) -->
                        <path id="gauge-arc" class="gauge-line text-gray-400"
                              stroke="currentColor" stroke-width="3" stroke-linecap="round" fill="none"
                              stroke-dasharray="0, 100"
                              d="M18 2.0845
                                 a 15.9155 15.9155 0 0 1 0 31.831
                                 a 15.9155 15.9155 0 0 1 0 -31.831"
                        />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="risk-percentage" class="text-3xl font-bold text-gray-800">--%</span>
                    </div>
                </div>

                <!-- Current Reading and Trend -->
                <div class="space-y-3">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-500 w-24">Last BG:</span>
                        <span id="current-glucose" class="text-3xl font-extrabold text-blue-600">---</span>
                        <span class="ml-2 text-lg text-gray-500">mg/dL</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-500 w-24">Trend (3h):</span>
                        <span id="glucose-trend" class="text-xl font-bold text-gray-700 flex items-center">
                            N/A
                        </span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-500 w-24">Last Update:</span>
                        <span id="current-time" class="text-md text-gray-600">---</span>
                    </div>
                </div>

                <!-- Recommendation -->
                <div id="recommendation-box" class="p-3 rounded-lg border w-full sm:w-1/3 text-center alert-low">
                    <p id="recommendation-text" class="font-semibold text-sm">Select a patient ID to view historical risk.</p>
                </div>
            </div>
        </div>

        <!-- Glucose Trend Chart -->
        <div class="card bg-white p-6 rounded-xl border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Patient 
                <span id="patient-chart-id" class="text-blue-600">---</span> - 
                Glucose History (Last 24 Entries)
            </h2>
            <div class="h-64">
                <canvas id="glucoseChart"></canvas>
            </div>
        </div>

        <!-- Patient Demographics & Activity Log (Removed manual logging) -->
        <div class="card bg-white p-6 rounded-xl border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Demographics & Key Activity (Last Entry)</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium text-gray-700">
                <div>Age: <span id="demo-age" class="font-bold text-gray-900">--</span></div>
                <div>Gender: <span id="demo-gender" class="font-bold text-gray-900">--</span></div>
                <div>Carbs (g): <span id="demo-carbs" class="font-bold text-gray-900">--</span></div>
                <div>Insulin (u): <span id="demo-insulin" class="font-bold text-gray-900">--</span></div>
                <div>Activity: <span id="demo-activity" class="font-bold text-gray-900">--</span></div>
                <div>Sleep Flag: <span id="demo-sleep" class="font-bold text-gray-900">--</span></div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let fullDataset = [];
        const CSV_FILE_PATH = 'glucose_timeseries_5000_24h.csv';

        /**
         * Fetches the CSV file content from the environment asynchronously.
         */
        async function fetchCSV(filePath) {
            try {
                document.getElementById('data-status').textContent = 'Fetching data... This may take a moment.';
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                return csvText;
            } catch (error) {
                console.error("Error fetching CSV:", error);
                document.getElementById('data-status').textContent = `ðŸš¨ Error loading data from ${filePath}. Check console.`;
                return null;
            }
        }


        /**
         * Parses the CSV string into an array of patient records.
         */
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',');
            
            const records = lines.slice(1).map(line => {
                const values = line.split(',');
                const dataPoint = {};
                headers.forEach((header, i) => {
                    const key = header.trim();
                    const value = values[i] ? values[i].trim() : '';

                    if (['id', 'age', 'hour', 'glucose_mg_dL', 'carbs_g', 'insulin_units', 'sleep_flag', 'hypo_next_3_hours', 'risk_score', 'pricks_per_day'].includes(key)) {
                        dataPoint[key] = parseFloat(value) || 0; // Parse key numbers
                    } else if (key === 'timestamp') {
                         // Parse the timestamp into a Date object
                        dataPoint[key] = new Date(value);
                    } else {
                        dataPoint[key] = value;
                    }
                });
                return dataPoint;
            }).filter(d => d.id > 0 && d.glucose_mg_dL > 0); // Filter for valid patient ID and BG

            return records;
        }

        /**
         * Loads and displays data for a specific patient ID.
         */
        function loadPatientData(patientId) {
            if (fullDataset.length === 0) {
                document.getElementById('data-status').textContent = "Error: Dataset not loaded. Please wait or check console.";
                return;
            }

            const patientHistory = fullDataset.filter(d => d.id === patientId);

            if (patientHistory.length === 0) {
                document.getElementById('data-status').textContent = `Patient ID ${patientId} not found or has no recorded data.`;
                document.getElementById('user-id-display').textContent = 'Showing data for Patient ID: â€”';
                updateDashboard([]); 
                return;
            }

            document.getElementById('data-status').textContent = `âœ… Successfully loaded ${patientHistory.length} records for Patient ID ${patientId}.`;
            document.getElementById('user-id-display').textContent = `Showing data for Patient ID: ${patientId}`;
            
            // Sort history by timestamp (most recent last)
            patientHistory.sort((a, b) => a.timestamp - b.timestamp);
            
            updateDashboard(patientHistory);
        }

        function loadPatientDataFromInput() {
            const inputId = document.getElementById('patient-id-input').value;
            const patientId = parseInt(inputId, 10);
            if (isNaN(patientId) || patientId <= 0) {
                document.getElementById('data-status').textContent = "Please enter a valid numeric Patient ID.";
                return;
            }
            loadPatientData(patientId);
        }
        
        /**
         * MOCK PREDICTION: Calculates the risk score (0-100) based on trend and key variables.
         * We use the pre-calculated 'risk_score' from the CSV if available, otherwise we use a heuristic.
         */
        function calculateRisk(history) {
            // Priority 1: Use the pre-calculated risk_score from the CSV (0-1 float)
            if (history.length > 0 && history[history.length - 1].risk_score !== undefined) {
                 // Convert the 0-1 risk_score from the CSV to a 0-100 percentage
                return Math.round(history[history.length - 1].risk_score * 100); 
            }

            // Priority 2: Fallback to heuristic if CSV score is missing
            if (history.length < 3) return 0;
            
            // Sort history by timestamp to ensure correct order
            history.sort((a, b) => a.timestamp - b.timestamp);
            
            const latestGlucose = history[history.length - 1].glucose_mg_dL;
            const threeHoursAgoData = history[history.length - 3];
            const threeHoursAgoGlucose = threeHoursAgoData ? threeHoursAgoData.glucose_mg_dL : history[0].glucose_mg_dL;

            const timeDiffHours = 3; 
            const roc = (latestGlucose - threeHoursAgoGlucose) / timeDiffHours;

            let levelPenalty = 0;
            if (latestGlucose < 100) { levelPenalty = 100 - latestGlucose; }

            let trendPenalty = 0;
            if (roc < 0) { trendPenalty = Math.abs(roc) * 5; }

            let rawRisk = (levelPenalty * 1.5) + (trendPenalty * 2); 
            let risk = Math.min(100, Math.max(0, rawRisk * 0.75)); 

            return Math.round(risk);
        }


        // --- UI & CHARTING LOGIC ---

        function getRecommendation(risk) {
            const box = document.getElementById('recommendation-box');

            box.className = 'p-3 rounded-lg border w-full sm:w-1/3 text-center transition duration-500';

            if (risk >= 70) {
                box.classList.add('alert-high');
                return "CRITICAL RISK: High likelihood of hypoglycemia in the next 3 hours.";
            } else if (risk >= 40) {
                box.classList.add('alert-medium');
                return "HIGH RISK: Patient's data shows a dangerous trend.";
            } else if (risk >= 15) {
                box.classList.add('alert-medium', 'border-yellow-400');
                return "MODERATE RISK: Caution advised, monitor trend closely.";
            } else {
                box.classList.add('alert-low');
                return "LOW RISK: History suggests stable glucose levels at this time.";
            }
        }

        function updateDashboard(history) {
            if (history.length === 0) {
                if(chart) chart.destroy(); chart = null;
                document.getElementById('risk-percentage').textContent = 'â€”%';
                document.getElementById('current-glucose').textContent = '---';
                document.getElementById('current-time').textContent = '---';
                document.getElementById('glucose-trend').innerHTML = 'N/A';
                document.getElementById('recommendation-text').textContent = 'Select a patient ID to view historical risk.';
                
                // Clear demographics
                document.getElementById('demo-age').textContent = '--';
                document.getElementById('demo-gender').textContent = '--';
                document.getElementById('demo-carbs').textContent = '--';
                document.getElementById('demo-insulin').textContent = '--';
                document.getElementById('demo-activity').textContent = '--';
                document.getElementById('demo-sleep').textContent = '--';
                document.getElementById('patient-chart-id').textContent = '---';
                return;
            }

            const latestData = history[history.length - 1];
            
            // 1. Calculate Risk
            const risk = calculateRisk(history);
            const recommendation = getRecommendation(risk);

            // 2. Update Risk Gauge
            const riskPercentageElement = document.getElementById('risk-percentage');
            const gaugeArc = document.getElementById('gauge-arc');
            const circumference = 100;
            
            riskPercentageElement.textContent = `${risk}%`;
            gaugeArc.style.strokeDasharray = `${risk} ${circumference}`;

            let colorClass = 'text-gray-400';
            if (risk >= 70) {
                colorClass = 'text-red-600';
            } else if (risk >= 40) {
                colorClass = 'text-orange-500';
            } else if (risk >= 15) {
                colorClass = 'text-yellow-500';
            } else {
                colorClass = 'text-green-500';
            }
            gaugeArc.classList.remove('text-gray-400', 'text-green-500', 'text-yellow-500', 'text-orange-500', 'text-red-600');
            gaugeArc.classList.add(colorClass);

            // 3. Update Current Readings
            document.getElementById('current-glucose').textContent = latestData.glucose_mg_dL.toFixed(0);
            document.getElementById('current-time').textContent = latestData.timestamp.toLocaleTimeString();
            document.getElementById('recommendation-text').textContent = recommendation;
            document.getElementById('patient-chart-id').textContent = latestData.id;

            // 4. Update Demographics
            document.getElementById('demo-age').textContent = latestData.age || '--';
            document.getElementById('demo-gender').textContent = latestData.gender || '--';
            document.getElementById('demo-carbs').textContent = latestData.carbs_g || '0';
            document.getElementById('demo-insulin').textContent = latestData.insulin_units || '0';
            document.getElementById('demo-activity').textContent = latestData.activity_event.toUpperCase() || 'NONE';
            document.getElementById('demo-sleep').textContent = latestData.sleep_flag === 1 ? 'YES' : 'NO';

            // 5. Update Trend Indicator (using 3-hour RoC)
            let trendText = 'N/A';
            let trendIcon = 'â€”';
            let trendColor = 'text-gray-700';

            if (history.length >= 3) {
                const latestGlucose = history[history.length - 1].glucose_mg_dL;
                const threeHoursAgoGlucose = history[history.length - 3].glucose_mg_dL;
                const roc = (latestGlucose - threeHoursAgoGlucose) / 3;

                if (roc > 5) {
                    trendText = `${roc.toFixed(1)} Rising/h`; trendIcon = 'â–²'; trendColor = 'text-green-600';
                } else if (roc < -5) {
                    trendText = `${Math.abs(roc).toFixed(1)} Dropping/h`; trendIcon = 'â–¼'; trendColor = 'text-red-600';
                } else {
                    trendText = 'Stable'; trendIcon = 'â€”'; trendColor = 'text-gray-500';
                }
            }

            const trendElement = document.getElementById('glucose-trend');
            trendElement.innerHTML = `<span class="${trendColor} text-2xl mr-2">${trendIcon}</span> ${trendText}`;
            trendElement.classList.remove('text-green-600', 'text-red-600', 'text-gray-500');
            trendElement.classList.add(trendColor);

            // 6. Update Chart
            updateChart(history);
        }

        function updateChart(history) {
            // Keep only the last 24 entries (one day) for the chart view
            const chartData = history.slice(-24); 

            const labels = chartData.map(d => 
                d.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            );
            const data = chartData.map(d => d.glucose_mg_dL);

            const ctx = document.getElementById('glucoseChart').getContext('2d');

            if (chart) {
                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
                return;
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Glucose (mg/dL)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 40,
                            max: 200,
                            title: { display: true, text: 'Glucose (mg/dL)' },
                            ticks: { callback: function(value) { return value + ' mg/dL'; } },
                            // Hypoglycemia threshold line
                            afterBuildTicks: function(axis) {
                                axis.ticks.push({ value: 70, label: 'HYPO (70)' });
                                axis.ticks.push({ value: 180, label: 'HIGH (180)' });
                                return axis.ticks;
                            },
                            grid: {
                                color: (context) => {
                                    if (context.tick.value === 70) return '#ef4444'; // Red for Hypo
                                    if (context.tick.value === 180) return '#f59e0b'; // Yellow for High
                                    return '#e5e7eb';
                                },
                                lineWidth: (context) => {
                                    if (context.tick.value === 70 || context.tick.value === 180) return 2;
                                    return 1;
                                },
                            }
                        },
                        x: {
                            title: { display: true, text: 'Time of Day' },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }
        
        // --- APP INITIALIZATION ---
        
        async function initializeApp() {
            const csvText = await fetchCSV(CSV_FILE_PATH);
            
            if (csvText) {
                fullDataset = parseCSV(csvText);
                const totalPatients = new Set(fullDataset.map(d => d.id)).size;
                document.getElementById('data-status').textContent = `âœ… Loaded ${fullDataset.length} records across ${totalPatients} patients. Enter ID to view.`;
            
                // Load patient 1 by default on successful initialization
                loadPatientData(1);
            } else {
                 document.getElementById('data-status').textContent = 'ðŸš¨ Data load failed. Check console for fetch errors.';
            }
        }

        // Run the initialization
        initializeApp();

    </script>
</body>
</html>